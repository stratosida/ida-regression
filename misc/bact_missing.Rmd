# Missing data


```{r, echo=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
## Load libraries
library(here)
library(tidyverse)
library(Hmisc)
library(naniar) ## for missing data 
library(gt)
library(kableExtra)
library(DT)
library(arsenal)
#load(here::here("data", "a_nhanes.rda"))


library(readr)
bact <- read_csv("~/Documents/TG3/IDA_Regression/github_bacteremia/Bacteremia_public.csv")
names(bact) <- make.names(casefold(names(bact)), allow_=FALSE)
bact<-bact %>% rename(age = alter)
bact<-bact %>% rename(sod = na.)
#bact<-bact %>% rename(sodium = na.)

vip<-c("age", "wbc", "bun", "krea", "plt", "neu")

```


## Per variable missingness

Number and percentage of missing. 

```{r, message =FALSE, warning =FALSE , echo=FALSE}
bact %>%
  select(-id) %>%
  miss_var_summary() %>%
  gt::gt() %>%
  gt::cols_label(
    variable = md("**Variable**"),
    n_miss = md("**Missing (count)**"),
    pct_miss = md("**Missing (%)**")
  ) %>%
  gt::fmt_number(
    columns = vars(pct_miss),
    decimals = 2
  )
```


```{r, message =FALSE, warning =FALSE , echo=FALSE}
bact %>%
  select(-id) %>%
  gg_miss_var(show_pct = TRUE)
```

## Variable summaries for complete vs incomplete cases

Six  pivotal variables are age, WBC, BUN, KREA, PLT, NEU. The variable summaries of patient characteristics are compared between cases where these are complete to those where these are missing.

```{r, results='asis', message =FALSE, warning =FALSE , echo=FALSE}

vip<-c("age", "wbc", "bun", "krea", "plt", "neu")

bact$missing<-"incomplete"
idx<-complete.cases(bact[,vip])
bact$missing[idx]<-"complete"


bact_complete<-tableby(missing ~ ., data=bact[,-1], test=TRUE, numeric.stats=c("median","q1q3", "range"))

# need results='asis' above for this to look good in the output
summary(bact_complete, title = "Participant characteristics by missing status of six pivotal variables")

tmp<-na.omit(bact)
x<-round(100*nrow(tmp)/nrow(bact),1)

sub<-na.omit(bact[,vip])
xsub<-round(100*nrow(sub)/nrow(bact[,vip]),1)

```

There are `r nrow(tmp)` (`r x` %) complete cases. The data set with the six pivotal variables age, WBC, BUN, KREA, PLT, NEU has `r nrow(sub)` (`r xsub` %) complete cases.

## Missingness and the outcome variable

```{r, results='asis', message =FALSE, warning =FALSE , echo=FALSE}

table(bact$bloodculture, bact$missing)

```

## Missingness and distributions of other variables (this is just an example)

```{r, results='asis', message =FALSE, warning =FALSE , echo=FALSE}
library(ggplot2)
ggplot(bact, 
       aes(x = sod, 
           y = hgb)) + 
  geom_miss_point() + 
 # facet_wrap(~ozo$WindDirection)+ 
  theme_bw() + theme(legend.title = element_blank()) 

```


## Missingness patterns over variables

```{r, message =FALSE, warning =FALSE , echo=FALSE}
library(VIM)
vars<-colnames(bact[,-1])
aggr(bact[,vars],numbers=TRUE)
```


```{r, message =FALSE, warning =FALSE , echo=FALSE}
bact %>%
  select(-id) %>%
  naniar::vis_miss(sort_miss = TRUE, show_perc_col = TRUE) 
```

```{r, message =FALSE, warning =FALSE , echo=FALSE}
bact %>%
  select(-id) %>%
  gg_miss_case()
```


```{r, message =FALSE, warning =FALSE , echo=FALSE}
bact %>%
  select(age, wbc, bun, krea, plt, neu ) %>%
  gg_miss_upset()

```




## (In)complete cases

This section presents patients with a least one missing value. First we list out patients with at least one missing value in a filterable table. 

```{r, message =FALSE, warning =FALSE , echo=FALSE}
cc <-
  bact %>%  
  select(-id) %>% 
  filter(!complete.cases(.))
DT::datatable(cc)
```

Then we report the pattern of missing for this set of patients. 

```{r, message =FALSE, warning =FALSE , echo=FALSE}
cc %>% gg_miss_upset()
```



## Section session info

```{r, message =FALSE, warning =FALSE , echo=FALSE}
sessionInfo()
```